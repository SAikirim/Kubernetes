# 09. 확장성(Scalability)
* 다중 서버 구성은 가용성 외에도 확장성 면에 효과가 있음

### 샘플 어플리케이션 다운로드
```zsh
$ git clone https://github.com/ToruMakabe/Understanding-K8s
$ cd Understanding-K8s/chap09
```

---
## 9.1 쿠버네티스 노드의 수평 자동 스케일
* Cluster Autoscaler
	- 쿠버네티스의 애드온으로 개발
	- 성능 및 부하에 따라 자동으로 노드를 늘리고 줄이는, 수평 자동 스케일 기능
* AKS의 확장 방법
항목|제공자| 수평 스케일 | 수직 스케일
---|---|---|---
Pod	| 쿠버네티스의 기능	| Horizontal Pod Autosacler(HPA)	| Vertical Pod Autoscaler(VPA)
Node| Azure의 기능	| as aks scale 명령	| -

##### Kubernetes Cluster Autoscaler
참고 : https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler

---
#### 1. Cluster Autoscaler
* Cluster Autoscaler의 기능
	- 포드에 할당 가능한 빈 리소스가 아무 노드에도 없을 경우 노드를 추가
	- 확장한 클러스터의 리소스 이용률이 내려가면 노드를 줄임
	- 'Pending' 상태인 포드의 유무로 판단

* 노드를 늘리는 기준은 'Pending인 포드가 있는지'임
	- 포드작성 시 원하는 리소스량을 'Rssource Requests'로 지정 -> 지정한 만큼의 빈 리소스가 노드에 없음 -> 그 포드의 스테이터스는 'Pending' 상태로 변함

![Cluster Autoscaler의 위치](./09. 확장성(Scalability)/kubernetes_00_ClusterAutoscaler의위치.jpg)[^출처]
* Cluster Autoscaler는 주기적으로 Pending 상태인 초드가 없는지를 확인(기본값: 10초)
* 새로운 노드 작성 의뢰는 인프라스트럭처의 '관리 인터페이스', Azure의 경우 Azure의 API에게 함
* 노드 작성은 인프라스트럭처 측에서 수행


---
## 9.2 AKS에 있어서 Cluster Autoscaler

Ex) Autoscaler를 도입하지 않은 상태에서 빈 리소스 확인  
```zsh
[] ~/Understanding-K8s/chap08 <master> ✗ kubectl describe nodes
Name:               aks-agentpool-28329859-vmss000000
~생략~
Allocatable:
  attachable-volumes-azure-disk:  4
  cpu:                            940m
~생략~
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource                       Requests     Limits
  --------                       --------     ------
  cpu                            655m (69%)   1750m (186%)
  memory                         719Mi (40%)  2270Mi (128%)
  ephemeral-storage              0 (0%)       0 (0%)
  attachable-volumes-azure-disk  0            0
Events:                          <none>
```
* 할당 가능한 CPU는 940m
* 이미 움직이고 있는 포드가 합계 655m를 요청
* 남은 것은 285m
	- 1 CPU(=1000m)는 Azure vCore를 의미


Ex) chap09/nginx.yaml  
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        resources:
          requests:
            cpu: 1000m
```

---
#### 1. Pending 상태를 만들어 낸다

Ex)   
```bash

```

Ex)   
```bash

```

---
#### 2. Cluster Autoscaler의 도입

Ex)   
```zsh

```

Ex)   
```zsh

```

---
#### 3. 노드 스케일 아웃

---
#### 4. 노드 수의 상한, 하한 설정

---
#### 5. 노드 스케일 인

---
#### 6. 인프라스트럭처 조작 권한 및 시크릿 관리


---
## 9.3 기타 자동 스케일

---
#### 1. HPA와 Cluster Autoscaler의 연동

---
#### 2. 쿠버네티스 외부의 메트릭을 사용한 자동 스케일

Ex)   
```bash

```

Ex)   
```bash

```


---
## 9.4 정리

---
[^출처]: 완벽한 IT 인프라 구축의 자동화를 위한 Kubernetes-정보문화사