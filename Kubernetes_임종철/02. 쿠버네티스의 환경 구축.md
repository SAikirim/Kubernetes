# 02. 쿠버네티스의 환경 구축
* 컨테이너 어플리케이션을 분산 환경에서 운용 관리하기 위한 오케스트레이션 툴

---
## 2.1 컨테이너 어플리케이션 개발의 흐름

---
#### 1. 쿠버네티스를 사용한 개발 및 운용의 흐름
![IoT 디바이스 전개와 관리 패턴](.\02. 쿠버네티스의 환경 구축\kubernetes_00_쿠버네티스를사용한개발의흐름.png)[^출처]

kubernetes_04_쿠버네티스를사용한개발의흐름.png
1. 개발환경의 준비
2. 컨테이너 이미지의 작성 및 공유
3. 클러스터 작성(실제 환경의 작성)

---
#### 2. Azure의 쿠버네티스 관련 서비스
* 구축은 간단하나, 서버의 다중화나 쿠버네티스 자체 버전업 등 실제 운용은 직접해야 함

* Azure가 제공하는 주요 컨테이너 서비스

서비스 | 설명
---|---
Azure Kuberetes Service(AKS) | 쿠너베티스의 매니지드 서비스. 요건에 따라 쿠버네티스 클러스터를 생성 및 운용 관리 가능
Azure Container Instances | 컨테이너 어플리케이션을 간편하게 실행하기 위한 서비스
Service Fabric | 마이트로 서비스의 개발과 컨테이너의 오케스트레이션 서비스
Web App for Containers | 업무에 맞춰 스케일링 가능한 컨테이너화된 웹 어플리케이션을 개발하기 윈한 PaaS
Azure Batch | 배치 잡을 실행하기 위한 서비스
Azure Container Registry(ACR) | 컨테이너 이미지를 저장 및 관리하기 위한 레지스트리. 프라이빗 환경에서 운용 가능
Azure DevOps Prejects | Azure에서 CI/CD 환경을 구축하기 위한 서비스, 실행 환경으로 쿠버네티스를 선택할 수 있음
Azure Dev spaces | Visual Studio 2017/Visual Studio Code를 사용하여 쿠버네티스의 개발 및 디버그를 수행하기 위한 서비스

* Azure 계정 필요
	- https://azure.microsoft.com/ko-kr/free/

---
## 2.2 개발 환경의 준비 

---
#### 1. Visual Studio Code 설치
* Visual Studio Code(VS Code)은 마이크로소프트가 제공하는 오픈소스 소스코드 에디터
	- 공식 사이트 : https://code.visualstudio.com/
* 주요기능
	- 디버그 가능
	- 구문 하이라이트
	- IntelliSense (입력 보완 기구)
	- Git과의 연계
	- 태스크 자동 실행
	- 확장 기능 임베이드
	- 통합 터미널 기능
* 개발용 PC에 맞춰 Windosw, Linux, macOS 중 선택 설치

---
#### 2. Azure CLI 명령의 설치
* Windows의 경우
	- https://aka.ms/installazurecliwindows
	- Windows 명령 프롬프트 또는 PowerShell에서 az 명령으로 실행
	
* macOS의 경우
	- `brew update && brew install azure-cli`
	
* Linux의 경우
	- Ubuntu 및 Debian
	`curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash`(Ubuntu 16.04+ 및 Debian 8+에서만 검증)
	- RHEL, Fedora, CentOS
	```bash
	$ sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
	$ sudo sh -c 'echo -e "[azure-cli]
	name=Azure CLI
	baseurl=https://packages.microsoft.com/yumrepos/azure-cli
	enabled=1
	gpgcheck=1
	gpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
	$ sudo yum install azure-cli
	```
	- 설치 후, Azure에 로그인(인증코드 입력)
	`az login`
	- 
	```bash
	$ az provider register -n Microsoft.Network
	$ az provider register -n Microsoft.Storage  
	$ az provider register -n Microsoft.Compute
	$ az provider register -n Microsoft.ContainerService
	```
	- Azure CLI 설치 참고: https://docs.microsoft.com/ko-kr/cli/azure/install-azure-cli

###### Azure CLI 명령의 출력 형식
* 기본값은 JSON 형식
* `--output` 옵션을 통해 출력 형식 변경가능
* `az confgure`를 사용해 영구 출력 형식 변경 
* '--no-headers` 옵션을 사용해 헤더정보 출력하지 않기

---
#### 3. kubectl 명령의 설치
* Windows의 경우
	- v1.17.0 다운: https://storage.googleapis.com/kubernetes-release/release/v1.17.0/bin/windows/amd64
	- 환경변수 PATH에 경로 설정 필요
	- PowerShell Gallery 패키지 매니저 또는 Chocolatey 패키지 매니저를 사용해 설치 가능
		+ https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-powershell-from-psgallery
		+ https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-powershell-from-psgallery
	
* macOS의 경우
	- `brew update && brew install kubernetes-cli`
	
* Linux의 경우
	- Ubuntu 및 Debian
	```bash
	sudo apt-get update && sudo apt-get install -y apt-transport-https
	curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
	echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list
	sudo apt-get update
	sudo apt-get install -y kubectl
	```
	
	- RHEL, Fedora, CentOS
	```bash
	cat <<EOF > /etc/yum.repos.d/kubernetes.repo
	[kubernetes]
	name=Kubernetes
	baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
	enabled=1
	gpgcheck=1
	repo_gpgcheck=1
	gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
	EOF
	yum install -y kubectl
	```
	- 버전 확인
	```bash
	~  $ kubectl version
	Client Version: version.Info{Major:"1", Minor:"17", GitVersion:"v1.17.4", GitCommit:"8d8aa39598534325ad77120c120a22b3a990b5ea", GitTreeState:"clean", BuildDate:"2020-03-12T21:03:42Z", GoVersion:"go1.13.8", Compiler:"gc", Platform:"linux/amd64"}
	The connection to the server localhost:8080 was refused - did you specify the right host or port?
	```
	
* kubectl 설치 및 설정
	- https://kubernetes.io/docs/tasks/tools/install-kubectl/
	
---
#### 4. Azure Cloud Shell 이용
![Azure Cloud Shell](.\02. 쿠버네티스의 환경 구축\kubernetes_01_AzureCloudShell.png)
* 브라우저에서 Azure를 명령 조작할 수 있는 웹  어플리케이션
* 클라이언트 단말기에 kubectl 명령이나 az 명령 등 설치가 어려울 때 사용
* Azure Cloud Shell의 개요
	- https://docs.microsoft.com/ko-kr/cli/azure/cloud-shell/overview
* 파일을 저장하려면 Azure Files 공유를 마운트해야 함

---
## 2.3 컨테이너 이미지의 빌드와 공개

---
#### 1. Azure Container Registry(ACR)
* ACRdms Azure가 제공하는 컨테이너 이미지 공유 서비스
	- 여러 리전 간에서 레지스트 관리
	- 보안과 CI/CD 연게
	- 컨테이너 이미지의 자동 빌드
	- ACR 공식 : https://azure.microsoft.com/ko-kr/services/container-registry

---
#### 2. ACR을 사용한 컨테이너 이미지 빌드와 공유

##### 레지스트리 작성
Ex) 레지스트리명 이용 가능 조회  
```zsh
~  $ az acr check-name -n sample                                                          2 ↵
{
  "message": "The registry sample is already in use.",
  "nameAvailable": false,
  "reason": "AlreadyExists"
}
```
* 'sample'은 중복으로 사용 불가

Ex) 레지스트리명 및 리소스 그룹명 변수 설정  
```bash
~  $ ACR_NAME=sample9988
~  $ ACR_RES_GROUP=$ACR_NAME
```
* 레지스트리명은 중복 불가, 리소스 그룹명은 중복 가능
* Azure에서는 '리소스 그룹'이라는 논리적인 단위로 리소스 관리

Ex) 리소스 그룹 작성  
```bash
~  $ az group create --resource-group $ACR_RES_GROUP --location koreacentral
Location      Name
------------  ----------
koreacentral  sample9988
```
* 로케이션은 한국 중부 리전(koreacentral)으로 사용
* `az confgure`를 사용해 '테이블' 형식으로 출력으로 변경

Ex)   
```bash

```
---
## 2.4 Azure를 사용한 쿠버네티스 클러스터 작성

---
#### 1. AKS를 사용한 클러스터 구축

Ex)   
```bash

```

Ex)   
```bash

```

---
#### 2. kubctl 명령을 사용한 클러스터의 기본 조작

Ex)   
```bash

```

Ex)   
```bash

```

---
## 2.5 정리

---
[^출처]: https://m.post.naver.com/viewer/postView.nhn?volumeNo=25598511&memberNo=15488377