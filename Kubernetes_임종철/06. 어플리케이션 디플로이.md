# 06. 어플리케이션 디플로이

### 샘플 어플리케이션 다운로드
```zsh
$ git clone https://github.com/ToruMakabe/Understanding-K8s
$ cd Understanding-K8s/chap06
```

---
## 6.1 디플로이먼트를 사용한 어플리케이션 디플로이

---
#### 1. 어플리케이션의 버전업 개념
* 작은 단위로 어플리케이셩 추가 기능을 넣거나 수정하여 짧은 기간에 릴리스하는 방법을 사용
	- 버전업에는 위험이 따름(오류 및 서비스 장애)
	- 안전한 어플리케이션을 가능한 신속하게 디플로이할 수 잇는 구조가 중요

* 디플로이하는 방법

##### 롤링 업데이트
* 한꺼번에 변경하는 것이 아닌, 조금씩 순서대로 갱신하는 방법(어플리케이션 버전을 조금씩 교체)
	- 신구 어플리케이션이 동시에 혼재하게 됨
	- 어플리케이션이 롤링 업데이트를 지원해야함

##### 불루/그린 디플로이먼트
* 버전이 다른 두 어플리케이션을 동시에 가동시켜 두고 네트워크 설정을 이용하여 변경
	- 블루(구)와 그린(신)을 전환
	- 대기 머신인 그린 쪽에서 사전 테스트, 테스트 통과 후 서비스 전환
	- 장애 발생신 블루(구)로 바로 되돌릴 수 있음

##### 카나리아 릴리스(Canary Release)
* 일부 이용자에게만 새 기능을 제공하여 문제 확인 후, 모든 사용자에게 대규모 전개

---
#### 2. 디플로이먼트
* '컨테이너 어플리케이션의 버전업' -> ''액세스할 포드를 바꾼다''는 것과 똑같음

    * 이것을 모아서 관리하는 기능이 디플로이먼트(Deployment)

* 포드 및 레플리카셋은 이력관리 개념이 없음

    * 디플로이먼트는 이력 관리 가능(배부에서 레플리카셋의 이력을 관리)

* 디플로이먼트가 가능한 일
	- 포드의 롤아웃/롤백
	- 롤아웃 방식의 지정
	- 롤아웃 조건이나 속도 제어
	
* 컨테이너 이미지의 버전업 등 업데이트가 있을 때 새로운 사양의 레플리카셋을 작성
    - 순서대로 새로운 포드를 대체하여 ‘롤아웃＇을 수행

---
#### 3. 매니페스트 파일

Ex) chap06/Deployment/nginx-deployment.yaml  
```yaml
# （1） 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # 레플리카 수
  selector:
    matchLabels:
      app: nginx-pod   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.14   # 컨테이너 이미지의 위치
        ports:
        - containerPort: 80   # 포트 번호
```
##### (1) 매니페스트 기본 항목
* API의 버전이나 포드명 같은 기본 항목 설정

필드| 데이터형 | 설명
---|---|---
apiVersion	| 문자열 | API의 버전(app/v1), 존재하니 않은 값을 설정하면 오류
kind 	| 문자열| 쿠버네티스 리소스 종류(Deployment)
metadata	| Object | Deployment의 이름이나 Label과 같은 메타데이터
spec	| PodSpec | Deployment의 상세 정보 설정


##### (2) 디플로이먼트 스펙
* [spec] 필드에는 디플로이먼트의 내용을 설정
	- 포드 안에서 실행시키고 싶은 포드 수를 replicas로 설정
	- 어떤 포드를 새로 가동시킬지 템플릿 설정

필드| 데이터형 | 설명
---|---|---
replicas	| 정수 | 클러스터 안에서 가동시킬 포드 수, 기본값 1
selector	| LabelSelector| 어떤 포드를 가동시킬지에 대한 셀렉터. 포드의 에 설정된 Template 라벨과 일치해햐 함
template	| PodTemplateSpec | 실제로 클러스터 안에서 움직이는 포드의 수가 replicas에 설정된 포드의 수를 만족시키지 않을 때 새로 작성되는 포드의 템플릿


##### (3) 포드 템플릿
* [template]필드에는 가동시키고 싶은 포드의 템플릿을 지정
* selector에서 지정한 조건과 맞는 것을 만들 필요가 있음

필드| 데이터형 | 설명
---|---|---
metadata	| Object | 템플릿의 이름이나 Label과 같은 메타테이터
spec	| PodSpec | pod의 상세 정보 설정

##### Deployment v1 apps - Kubernetes API Reference Docs
참고 : https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#deployment-v1-apps

---
#### 디플로이먼트 작성, 변경, 삭제

##### 디플로이먼트 작성
Ex) 디플로이먼트 작성 및 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl apply -f Deployment/nginx-deployment.yaml                         [git:master] ✖
deployment.apps/nginx-deployment created

~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           20s
```
* 자동으로 레플리카셋과 포드가 만들어짐
* 디플로이먼트 명령 결과
항목 | 설명
:-:|---
NAME | 디플로이먼트명
READY | 가동 가능한 레플리카 수/총 설정된 레플리카 수
UP-TO-DATE | 갱신된 레플리카 수
AVAILABLE | 사용 가능한 레플리카 수
AGE	| 어플리케이션 실행 시간

Ex) 포드 및 레플리카셋 확인  
```zsh
➞  kubectl get replicaset,pod                                                [git:master] ✖
NAME                                                DESIRED   CURRENT   READY   AGE
replicaset.extensions/nginx-deployment-789d949f8b   3         3         3       59s

NAME                                    READY   STATUS    RESTARTS   AGE
pod/nginx-deployment-789d949f8b-75xr4   1/1     Running   0          59s
pod/nginx-deployment-789d949f8b-8sbx9   1/1     Running   0          59s
pod/nginx-deployment-789d949f8b-ml9m2   1/1     Running   0          59s
```
* [NAME] : 디플로이먼트명-레플리카셋_내부_ID-포드_내부_ID
![포드, 레플리카, 디플로이먼트의 이름](.\06. 어플리케이션 디플로이\kubernetes_00_포드레플리카디플로이먼트이름.jpg)[^출처]

Ex) 디플로이먼트 상세정보  
```zsh
➞  kubectl describe deploy nginx-deployment                                  [git:master] ✖
Name:                   nginx-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 10:40:29 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 1
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},"spec":{"replica...
Selector:               app=nginx-pod
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx-pod
  Containers:
   nginx:
    Image:        nginx:1.14
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   nginx-deployment-789d949f8b (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deployment-789d949f8b to 3
```
* [OldReplicaSets:]와 [NewReplicaSet:] : 레플리카셋의 이력을 유지

##### 디플로이먼트 변경

Ex) chap06/Deployment/nginx-deployment.yaml  
```yaml
# （1） 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # 레플리카 수
  selector:
    matchLabels:
      app: nginx-pod   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.14   # 컨테이너 이미지의 위치
        ports:
        - containerPort: 80   # 포드 번호
```
* 'image: nginx:1.14' -> 'image: nginx:1.15'로 변경

Ex) 디플로이먼트 갱신 및 확인  
```zsh
➞  kubectl apply -f Deployment/nginx-deployment.yaml                         [git:master] ✖
deployment.apps/nginx-deployment configured

~/Understanding-K8s/chap06
➞  kubectl describe deploy nginx-deployment                                  [git:master] ✖
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    ReplicaSetUpdated
OldReplicaSets:  nginx-deployment-789d949f8b (3/3 replicas created)
NewReplicaSet:   nginx-deployment-69fdb6677 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  16m   deployment-controller  Scaled up replica set nginx-deployment-789d949f8b to 3
  Normal  ScalingReplicaSet  7s    deployment-controller  Scaled up replica set nginx-deployment-69fdb6677 to 1
```
* 'nginx-deployment-789d949f8b' -> 'nginx-deployment-69fdb6677' 대체 확인

Ex) 디플로이먼트 내부 레플리카셋 이력 확인  
```zsh
➞  kubectl get replicaset --output=wide                                      [git:master] ✖
NAME                          DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES       SELECTOR
nginx-deployment-69fdb6677    3         3         3       2m51s   nginx        nginx:1.15   app=nginx-pod,pod-template-hash=69fdb6677
nginx-deployment-789d949f8b   0         0         0       18m     nginx        nginx:1.14   app=nginx-pod,pod-template-hash=789d949f8b
```
* 'pod-template-hash='에는 해시 값이 자동으로 붙음
	- 이 값을 사용해 내부에서 포드를 식별, 값 변경 금지

##### 디플로이먼트 삭제

Ex) 디플로이먼트 삭제 및 확인 
```zsh
~/Understanding-K8s/chap06
➞  kubectl delete -f Deployment/nginx-deployment.yaml                        [git:master] ✖
deployment.apps "nginx-deployment" deleted
~/Understanding-K8s/chap06
➞  kubectl get replicaset,pod,deploy                                         [git:master] ✖
No resources found in default namespace.
```
* 디플로이먼트를 삭제하면 연결되어 있던 리플리카셋 및 포드 모두 삭제됨

---
## 6.2 디플로이먼트의 구조
![샘플 어플리케이션 개요](.\06. 어플리케이션 디플로이\kubernetes_01_샘플어플리케이션개요.jpg)[^출처]

---
#### 1. 업데이트 처리 방식
* 리크리에이트(Recreate)
	- 오래된 포드를 일단 정지시키고 새로운 포드를 다시 작성하는 방법
	- 심플하며 속도가 빠름, 다운타임이 발생
	
* 롤링 업데이트(RollongUpdate)
	- 클러스터에서 움직이는 포드를 조금씩 업데이트해 가는 방식
	- 새로운 포드의 실행이 확인되면 오래된 포드를 정지
	- 신구 버전이 동시에 존재(처리 방법은 복잡), 다운타임이 없음
	

![업데이트 방식](.\06. 어플리케이션 디플로이\kubernetes_02_업데이트방식.jpg)[^출처]

Ex) 업데이트 처리 방식의 설정  
```zsh
# B. Deploymentのスペック
spec:
  replicas: 10   # 레플리카 수

  # 업데이트 방식
  strategy:
    type: Recreate
```
* 디플로이먼트의 [spec:]-[strategy:]-[type:]에서 설정
	- 설정 가능 값  'Recreate' 및 'RollingUpdate'
	- 명시적 지정이 없으면 기본값 : 'RollingUpdate'

---
#### 2. 롤아웃
* 어플리케이션을 클러스터 안에 디플로이하여 서비스를 가동시키는 것

Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
# (1) 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollout-deployment

# (2) Deploymentのスペック
spec:
  replicas: 5   # 레플리카 수
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v1.0   # 여기를 변경한다
        name: photoview-container   # コンテナ名
        ports:
        - containerPort: 80   # 포드 번호
---
# A. 基本項目
apiVersion: v1
kind: Service
metadata:
  name: rollout

# B. Serviceのスペック
spec:
  type: LoadBalancer
  ports:   # 포트번호
    - port: 80
      targetPort: 80
      protocol: TCP

  # C. Pod 조건(ラベル)
  selector:
    app: photo-view
```
* 'rollout-deployment'라는 이름의 디플로이먼트를 만듦
* 5개의 포드 실행
* [image] 필드는 자신의 레지스트리 주소로 변경
* 서비스 리소스도 작성

Ex) 디플로이먼트 및 서비스 작성과 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment created
service/rollout created

~/Understanding-K8s/chap06
➞  kubectl rollout status deploy rollout-deployment                          [git:master] ✖
deployment "rollout-deployment" successfully rolled out

~/Understanding-K8s/chap06
➞  kubectl get pod                                                           [git:master] ✖

NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-fd94bf9b7-2xlhh   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-kgdp7   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-vz2pm   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-wmwvj   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-xfrrs   1/1     Running   0          20s
```

Ex) 외부에서 액세스 할 수 있는 글로벌IP 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl get service                                                       [git:master] ✖
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE
kubernetes   ClusterIP      10.0.0.1       <none>           443/TCP        6d
rollout      LoadBalancer   10.0.162.173   52.231.112.242   80:30325/TCP   2m41s
```

![동작 확인](.\06. 어플리케이션 디플로이\kubernetes_03_동작확인.png)
* '52.231.112.242'에 접속 동작 확인


Ex) 디플로이먼트 상세 정보 확인1  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 1
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"rollout-deployment","namespace":"default"},"spec":{"repli...
~생략~
```
* [Annotations:]필드에 'revision: 1'이 자동 추가됨
	- 이 값은 디플로이먼트의 리버전을 뜻하며, 롤링 업데이트를 할 때 마다 증가

Ex) 디플로이먼트 상세 정보 확인2  
```zsh
~생략~
Selector:               app=photo-view
Replicas:               5 desired | 5 updated | 5 total | 5 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
~생략~
```
* 롤링 업데이트의 상황 확인 가능

Ex) 디플로이먼트 상세 정보 확인3  
```zsh
~생략~
Pod Template:
  Labels:  app=photo-view
  Containers:
   photoview-container:
    Image:        sampleacr9988.azurecr.io/photo-view:v1.0
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
~생략~
```
* 포드의 상세 정보는 레플리카셋이나 포드의 경우와 똑같음
* 포드 사양 확인 가능

Ex) 디플로이먼트 상세 정보 확인4  
```
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   rollout-deployment-fd94bf9b7 (5/5 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  6m47s  deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
```
* [Conditions:] : 디플로이먼트 상태 확인
* [Events:] : 로그 상태 확인
* [OldReplicaSets:] : 구버전 레플리카셋
* [NewReplicaSet:] : 신버전 레플리카셋

##### 어플리케이션 버전업
Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v2.0   # 여기를 변경한다(v1.0 => v2.0)
        name: photoview-container   # コンテナ名
~생략~
```

Ex) 디플로이먼트 갱신 및 확인  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged

~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
rollout-deployment   5/5     5            5           17m

~/Understanding-K8s/chap06
➞  kubectl get rs                                                            [git:master] ✖
NAME                            DESIRED   CURRENT   READY   AGE
rollout-deployment-57df5b5978   5         5         5       33s
rollout-deployment-fd94bf9b7    0         0         0       17m
```

Ex) [Events]의 로그를 확인  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
~생략~
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  18m   deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 2
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 4
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 3
  Normal  ScalingReplicaSet  90s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 3
  Normal  ScalingReplicaSet  90s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 4
  Normal  ScalingReplicaSet  88s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 2
  Normal  ScalingReplicaSet  88s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 5
  Normal  ScalingReplicaSet  86s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 1
  Normal  ScalingReplicaSet  85s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 0
```
* 'rollout-deployment-fd94bf9b7'에서 'rollout-deployment-57df5b5978'로 교체
	1. 새로운 레플리카셋을 작성
	2. 새로운 레플리카셋의 포드를 늘림
	3. 오래된 레플리카셋의 포드를 줄임
	4. 오래된 레플리카셍의 포드라 0이 될 때까지 2.와 3.을 반복
* 서비스가 정지되지 않도록 내부에서 무결성을 취하면서 서서히 롤아웃함

---
#### 3. 롤백
Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v1.0   # 여기를 변경한다(v2.0 => v1.0)
        name: photoview-container   # コンテナ名
~생략~
```

Ex) 디플로이먼트 갱신  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged
```

Ex) 디플로이먼트 상세 정보 확인1  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 3
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"rollout-deployment","namespace":"default"},"spec":{"repli...
~생략~
```
* [Annotations:]필드가 'revision: 3'으로 올라간 것을 확인

Ex) 디플로이먼트 상세 정보 확인2  
```zsh
~생략~
Pod Template:
  Labels:  app=photo-view
  Containers:
   photoview-container:
    Image:        sampleacr9988.azurecr.io/photo-view:v1.0
~생략~
```
* 포드 템플릿 이미지가 'v2.0'에서 'v1.0'로 변경 확인

Ex)   
```zsh
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   rollout-deployment-fd94bf9b7 (5/5 replicas created)
Events:
  Type    Reason             Age                  From                   Message
  ----    ------             ----                 ----                   -------
  Normal  ScalingReplicaSet  27m                  deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 2
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 4
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 3
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 3
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 4
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 2
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 5
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 1
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 0
  Normal  ScalingReplicaSet  110s (x9 over 114s)  deployment-controller  (combined from similar events): Scaled down replica set rollout-deployment-57df5b5978 to 0
```
* 'rollout-deployment-fd94bf9b7'로 되돌아 온 것을 확인


Ex) 디플로이먼트 및 레플리카셋 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
rollout-deployment   5/5     5            5           35m

~/Understanding-K8s/chap06
➞  kubectl get rs                                                            [git:master] ✖
NAME                            DESIRED   CURRENT   READY   AGE
rollout-deployment-57df5b5978   0         0         0       17m
rollout-deployment-fd94bf9b7    5         5         5       35m
```
* 디플로이먼트의 리버전은 'revision:2.0'에서 'revision:3.0'으로 올라갔지만
* 참조한 레플리카셋은 'revision:3.0'과  'revision:1.0'이 똑같은 것을 사용하여 포드를 기동시키고 있음
* __갖고 있는 이력을 바탕으로 롤백하고 있음__

---
#### 4. 롤아웃 조건
* 롤아웃은 극단적으로 말하면 '포드를 변경하기' 위한 장치
	- 포드 템플릿 이외의 변경에는 리비전이 올라가지 않음
	

Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
# (2) Deploymentのスペック
spec:
  replicas: 10   # 레플리카 수(5 => 10 변경)
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건
~생략~
```

Ex) 디플로이먼트 갱신 및 포드 개수 확인  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged

~/Understanding-K8s/chap06
➞  kubectl get pod                                                           [git:master] ✖
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-fd94bf9b7-4btm2   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-4xzss   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-8hhtc   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-brzn5   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-cwzbm   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-f4wc7   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-nzcmm   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-q7mbn   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-tms99   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-vlgb7   1/1     Running   0          9s
```

Ex) 디플로이먼트 상세 확인   
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 3
~생략~
```
* [Annotations:]필드의 'revision: 3'상태 그대로인 것을 확인
	- 디플로이먼트 매니페스트의 [template] 필드의 갱신 외에는 업데이트되지 않음(주의 필요)
	- 포드 템플릿을 변경했을 때만 롤아웃 됨

Ex) 디플로이먼트 이력 확인  
```zsh
~ kubectl rollout history deployment rollout-deployment
deployment.extensions/rollout-deployment
REVISION  CHANGE-CAUSE
2         <none>
3         <none>
```
* 'kubectl rollout history' 명령을 사용하여 롤아웃에서 어떤 변경이 일어났는지 확인

Ex) 리비전별 상세 내용 확인  
```zsh
chap06 [master●] kubectl rollout history deployment rollout-deployment --revision=3
deployment.extensions/rollout-deployment with revision #3
Pod Template:
  Labels:       app=photo-view
        pod-template-hash=fd94bf9b7
  Containers:
   photoview-container:
    Image:      sampleacr9988.azurecr.io/photo-view:v1.0
    Port:       80/TCP
    Host Port:  0/TCP
    Environment:        <none>
    Mounts:     <none>
  Volumes:      <none>
```
* 'revision=3'의 내용 확인
* 장기간 운용시 '이력 정보'가 커짐, 롤백 세대를 지정을 권장(기본값: 10)
	- 변경시 디플로이먼트 스펙에서 [revisionHistroryLimit]를 설정

##### Deployments - Kuberntes
참고 : https://kubernetes.io/docs/concepts/workloads/controllers/deployment

Ex) 리소스 삭제  
```zsh
chap06 [master●] kubectl delete -f Deployment/rollout-depoyment.yaml
deployment.apps "rollout-deployment" deleted
service "rollout" deleted
```

---
#### 5. 롤링 업데이트 제어
* 디플로이먼트는 롤링 처리를 세세하게 제어 가능
	- Ex) 업데이트 중에 성능을 최소한으로 줄이기

###### 사용할 수 없는 포드 제어(maxUnavilable)
* 업데이트 중, 사용 못 해도 괜찮은 포드의 최대 개수를 지정, 포드의 수 또는 전체 포드의 비율로 설정함
* 디플로이먼트의 [spec:]-[strategy]-[rolliongUpdate]-[maxUnavailable]에서 설정
Ex) [maxUnavailable]를 30%로 설정(10개의 포드를 가동중이라면)
	- 70%이상, 7개 이상의 포드가 클러스터 안에서 항상 이용할 수 있는 상태를 유지
	- [maxUnavailable]를 명시적으로 지정하지 않았을 땐(기본값: 25%)

###### 클러스터에서 포드를 작성할 수 있는 최대 개수(maxSurge)
* 폴아웃을 할 때 어느 정도의 추가 리소스를 작성할 수 있는지를 제어할 때 사용, 포드의 수 또는 전체 포드의 비율로 설정함
* 디플로이먼트의 [spec:]-[strategy]-[rollingUpdate]-[maxSurge]에서 설정
Ex) [maxSurge]를 30%로 설정(10개의 포드를 가동중이라면)
	- 롤링 업데이트가 시작되자마자 바로 레플리카셋을 확대하여 오래된 포드와 새로운 포드의 합계가 130%가 넘지 않도록 제어
	- [maxSurge]를 명시적으로 지정하지 않았을 땐(기본값: 25%)
	- 높게 설정하면 컴퓨팅 리소스 많이 필요

Ex) chap06/Deployment/rollingupdate-deployment.yaml
```yaml
# A. 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rolling-deployment

# B. Deploymentのスペック
spec:
  replicas: 10   # レプリカ 수

  # 롤링 업데이트 설정
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 30%
      maxUnavailable: 10%

  selector:
    matchLabels:
      app: photo-view   # テンプレートの検索条件

  # C. Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
      - image: asaacrregistry.azurecr.io/photo-view:v2.0   # 컨테이너 이미지 장소
        name: photoview-container   # コンテナ名
        ports:
        - containerPort: 80   # 포트번호
```
* 클러스터에서 작성 가능 최대 포드 수 30%
  - 업데이트 중에 사용할 수 없는 포드는 전체의 10%


Ex) 롤링 업데이트 작성 및 확인  
```zsh
chap06 [master●] kubectl apply -f Deployment/rollingupdate-deployment.yaml
deployment.apps/rolling-deployment created
chap06 [master●] kubectl describe deploy rolling-deployment
Name:                   rolling-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 20:04:09 +0900
~생략~
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  10% max unavailable, 30% max surge
~생략~
```
* [RollingUpdateStrategy]필드에 maxUnavailable과 maxSurge가 표시됨
* maxUnavailable과 maxSurge는 레플리카 수의 개수 지정이 가능하지만, 퍼센트(비율)로 지정을 권장
	- 레플리카 수는 동적으로 변화하기에 수로 스케일할 시 문제가 발생할 수 있음

##### Readiness Probe
* Readiness Probe의 결과를 보고, 갱신한 포드가 정상적으로 움직인다는 것을 판단함
* 'Liveness Probe'와 마찬가지로 헬스 체크를 함
* 가동 상태 감시 방법
	1. HTTP 리퀘스트의 반환값을 체크
	3. TCP Socket으로 연결할 수 있는지를 체크
	4. 명령의 실행 결과를 체크
* 'Liveness Probe'와 'Readiness Probe'는 동일한 컨테이너에 대해 둘 다 설정 가능
	- 디플로이먼트를 사용할 때는 반드시 설정을 권장함

Ex) Readiness Probe를 사용한 포드 감시 
```yaml
    reainessProbe:
      httpGet:  # HTTP 리퀘스트의 반환값에 따른 체크를 한다.
        path: /healthz
        port: 8080
        httpHeaders:
        - name: X-Custom-Header
          value: Awesome
      initialDelaySeconds: 3
      periodSeconds: 3
```

---
#### 6. 블루/그린 디플로이먼트

Ex) chap06/Deployment/blue-deployment.yaml   
```yaml
# (1) 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # レプリカ 수
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view
        ver: v1.0
    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v1.0   # 컨테이너 이미지 저장 위치(저장소 위치와 테그 변경)
        name: photoview-container   # コンテナ名
        ports:
        - containerPort: 80   # 포트 번호
```

Ex) chap06/Deployment/green-deployment.yaml    
```yaml
# (1) 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: green-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # レプリカ 수
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view
        ver: v2.0
    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v2.0   # 컨테이너 이미지 저장 위치(저장소 위치와 테그 변경)
        name: photoview-container   # コンテナ名
        ports:
        - containerPort: 80   # 포트 번호
```

Ex) 블루/그린 디플로이   
```zsh
chap06 [master●] kubectl apply -f Deployment/blue-deployment.yaml
deployment.apps/blue-deployment created
chap06 [master●] kubectl apply -f Deployment/green-deployment.yaml
deployment.apps/green-deployment created
```

Ex) 블루/그린 디플로이 확인  
```zsh
chap06 [master●] kubectl get pod
NAME                               READY   STATUS    RESTARTS   AGE
blue-deployment-69d964d5df-d2lbn   1/1     Running   0          12m
blue-deployment-69d964d5df-tw6p4   1/1     Running   0          12m
blue-deployment-69d964d5df-vvqqp   1/1     Running   0          12m
green-deployment-c4dcf84c-g5q2v    1/1     Running   0          11m
green-deployment-c4dcf84c-mpvxr    1/1     Running   0          11m
green-deployment-c4dcf84c-px9q8    1/1     Running   0          11m
```

Ex) chap06/Deployment/service.yaml  
```yaml
# (1) 基本項目
apiVersion: v1
kind: Service
metadata:
  name: webserver

# (2) Serviceのスペック
spec:
  type: LoadBalancer
  ports:   # 포트번호
    - port: 80
      targetPort: 80
      protocol: TCP

  # (3) Pod 조건(ラベル)
  selector:
    app: photo-view
    ver: v1.0
```
* 라벨이 'ver: v1.0'인 포드, 'blue-deployment'인 포드로 전송

Ex) 서비스 작성 및 IP 주소 확인
```zsh
chap06 [master●] kubectl apply -f Deployment/service.yaml
service/webserver created
chap06 [master●] kubectl get svc
NAME         TYPE           CLUSTER-IP    EXTERNAL-IP     PORT(S)        AGE
kubernetes   ClusterIP      10.0.0.1      <none>          443/TCP        6d9h
webserver    LoadBalancer   10.0.120.70   52.231.118.37   80:30194/TCP   107s

```
![동작 확인(v1.0)](.\06. 어플리케이션 디플로이\kubernetes_04_동작확인v1.0.png)

Ex) chap06/Deployment/service.yaml  
```yaml
~생략~
  # (3) Pod 조건(ラベル)
  selector:
    app: photo-view
    ver: v2.0
```
* 라벨을 'ver: v1.0'에서 'ver: v2.0'로 변경

Ex) 서비스 갱신
```zsh
chap06 [master●] kubectl apply -f Deployment/service.yaml
service/webserver configured
```
![동작 확인(v2.0)](.\06. 어플리케이션 디플로이\kubernetes_05_동작확인v2.0.png)
* 'Label Selector'를 전환하기만 함으로써 블루/그린 디플로이먼트를 구현할 수 있음

Ex) 리소스 모두 삭제  
```zsh
chap06 [master●] kubectl delete -f Deployment/
deployment.apps "blue-deployment" deleted
deployment.apps "green-deployment" deleted
```
---
## 6.3 어플리케이션의 설정 정보를 관리하자

---
#### 1. 어플리케이셔의 설정 정보 관리
* ConfigMap(컨피그맵)
	- 어플리케이션에서 이용하는 환경 의존적인 변수를 모아서 관리하기 위한 상자같은 것
* 작성 방법
	- 쿠베네티스의 매니페스트 파일을 작성
	- 어플리케이션의 config 파일을 마운트
	- kubectl 명령을 사용하여 작성
	

![컨피그맵](.\06. 어플리케이션 디플로이\kubernetes_06_ConfigMap.jpg)	
	
##### 쿠베네티스의 매니페스트 파일을 작성

Ex) chap06/ConfigMap/configmap.yaml  
```yaml
# (1) 基本項目
apiVersion: v1
kind: ConfigMap
metadata:
    name: project-config

# (2) ConfigMap에서 설정할 데이터
data:
    project.id: "hello-kubernetes"
```
* [kind:]는 ConfigMap
* 키는 'project.id', 값은 "hello-kubernetes"로 정의

Ex) 컨피그맵 작성 및 확인  
```zsh
 chap06 (master) ✗ kubectl apply -f ConfigMap/configmap.yaml
configmap/project-config created
 chap06 (master) ✗ kubectl get configmaps
NAME             DATA   AGE
project-config   1      12s
```
* 'project-config'라는 컨피그맵 작성 확인

Ex) 컨피그맵 상세 확인   
```zsh
 chap06 (master) ✗ kubectl describe configmaps project-config
Name:         project-config
Namespace:    default
Labels:       <none>
Annotations:  kubectl.kubernetes.io/last-applied-configuration:
                {"apiVersion":"v1","data":{"project.id":"hello-kubernetes"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"project-config","names...

Data
====
project.id:
----
hello-kubernetes
Events:  <none>
```

##### 어플리케이션의 config 파일을 마운트
* 일반적으로 어플리케이션은 여러 개의 파라미터 설정 정보를 가짐
	- 이것을 파일로 관리할 시, 파일을 통째로 마운트 가능

Ex) config 파일  
```zsh
 chap06 (master) ✗ cat ConfigMap/config/ui.ini
; 設定ファイルの例
[UI]
color.top = blue
text.size = 10
```

Ex) 컨피그맵 등록(설정, 마운트)  
```zsh
 chap06 (master) ✗ kubectl create configmap app-congfig --from-file=ConfigMap/config/
configmap/app-congfig created
```
* `--from-file`을 사용해 파일 경로 및 파일명(디렉터리명) 지정
* 'config' 디렉터리에 있는 설정 파일을 모아서 'app-config'라는 이름의 컨피그맵으로 등록

Ex) 컨피그맵 확인  
```zsh
 chap06 (master) ✗ kubectl get configmaps
NAME             DATA   AGE
app-congfig      1      24s
project-config   1      10m
```

---
#### 2. ConfigMap 값 참조
* 포드의 템플릿 [spec]에서 컨피그맵의 값을 참조할 때, 환경변수로 전달할지, Volume으로 마운트할지 설정 가능

##### 환경변수로써 전달하기
* 컨피그맵을 환경변수로 전달할 때는 [containers]-[env]필드를 사용

Ex) chap06/ConfigMap/deployment.yaml   
```yaml
~생략~
  # (3) Pod 탬플릿
  template:
    metadata:
      labels:
        app: config-view
    spec:
      containers:
~생략~
        # ConfigMap을 환경변수에 설정
        env:
        - name: PROJECT_ID
          valueFrom:
            configMapKeyRef:
              name: project-config
              key: project.id
~생략~
```
* [valueFrom]을 'configMapKeyRef' 하고, 참조하고 싶은 컨피그맵의 이름을 [name], 키는 [key] 필드에 지정
* 위쪽에서 정의한 'project-config'의 값을 환경변수 PROJECT_ID로 설정하고 있음 

##### Volume으로써 마운트하기
* 등록한 컨피그맵을 파일로써 마운트할려면 [containers]-[voulumeMounts]필드에 설정
  

Ex) chap06/ConfigMap/deployment.yaml   
```yaml
# (1) 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: configmap-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # レプリカ数
~생략~
  # (3) Pod 탬플릿
  template:
    metadata:
      labels:
        app: config-view
    spec:
      containers:
~생략~
        # ConfigMap의 마운트 설정
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
			
      # ConfigMap의 볼륨 마운트
      volumes:
        - name: config-volume
          configMap:
            name: app-config
```
* 위에서 설정한 'app-config'라는 이름의 컨피그맵을 컨테이너 '/etc/config/'에 마운트

Ex) 컨테이너 이미지 작성(v3.0)  
```zsh
 chap06 (master) ✗ ACR_NAME=sampleACR9988
 chap06 (master) ✗ az acr build --registry $ACR_NAME --image photo-view:v3.0 ConfigMap/v3.0
Packing source code into tar to upload...
Uploading archived source code from '/tmp/build_archive_dcce7c749d134f82849475e9232fd25c.tar.gz'...
Sending context (325.680 KiB) to registry: sampleACR9988...
Queued a build with ID: de3
~생략~
- image:
    registry: sampleacr9988.azurecr.io
    repository: photo-view
    tag: v3.0
    digest: sha256:89776dd6c3cc360fb5e5103b4bc4d4573a2945fe9812685f5159decf9688f5db
  runtime-dependency:
    registry: registry.hub.docker.com
    repository: library/python
    tag: "3.6"
    digest: sha256:0b6aeeb47c4a5e0051bb41c7a7f300b69e68af873081f8f2f7fbcd8d5c47e264
  git: {}

Run ID: de3 was successful after 58s
```
* 포드 안의 어플리케이션에서 컨피그맵의 값을 참조하기 위해 샘플 어플리케이션을 버전업(v3.0)

Ex) chap06/ConfigMap/deployment.yaml   
```yaml
~생략~
  # (3) Podのテンプレート
  template:
    metadata:
      labels:
        app: config-view
    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v3.0   # 컨테이너 이미지 장소(자신의 레지스트리로 변경)
        name: photoview-container   # コンテナ名
        imagePullPolicy: Always   # コンテナイメージのpull条件
~생략~
```
* [image]의 위치(경로) 수정

Ex) 디플로이먼트 및 서비스 리소스 작성과 서비스 IP 확인  
```zsh
 chap06 (master) ✗ kubectl apply -f ConfigMap/deployment.yaml
deployment.apps/configmap-deployment created
service/webserver created
 chap06 (master) ✗ kubectl get svc
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP      10.0.0.1       <none>        443/TCP        7d
webserver    LoadBalancer   10.0.168.143   52.141.30.204 80:31395/TCP   74s
```

![동작확인(v3.0)](.\06. 어플리케이션 디플로이\kubernetes_07_동작확인v3.0.png)	
* 참조하고 있는 포드는 바뀌지만, 컨피그맵에서 설정한 내용은 어떤 포드에서든 똑같은 값으로 되어 있음

Ex) 포드 작동 확인  
```zsh
 chap06 (master) ✗ kubectl get pod
NAME                                    READY   STATUS    RESTARTS   AGE
configmap-deployment-84c4ddc495-8r6k6   1/1     Running   0          6m24s
configmap-deployment-84c4ddc495-f7lvt   1/1     Running   0          6m24s
configmap-deployment-84c4ddc495-jq9wm   1/1     Running   0          6m24s
```

Ex) 포드에 접속 및 환경변수 확인  
```zsh
 chap06 (master) ✗ kubectl exec -it configmap-deployment-84c4ddc495-8r6k6 /bin/bash
root@configmap-deployment-84c4ddc495-8r6k6:/# env | grep PROJECT_ID
PROJECT_ID=hello-kubernetes
```
* 'configmap-deployment-84c4ddc495-8r6k6'에 접속
* 환경변수 확인

Ex) 마운트된 설정 파일 확인  
```zsh
root@configmap-deployment-84c4ddc495-8r6k6:/# ls /etc/config/
ui.ini
root@configmap-deployment-84c4ddc495-8r6k6:/# cat /etc/config/ui.ini
; 設定ファイルの例
[UI]
color.top = blue
text.size = 10
```
* 남은 두 대의 포드도 확인하면 똑같은 환경변수와 파일이 마운트되어 있을 것임
* 컨피그맵으로 모아서 관리 -> 이식성이 올라감, 설정 누락 등 환경에 의존하는 문제를 줄임
* __컨피그맵이 참조되지 않으면 포드가 정상적으로 움직이지 않으니 주의!__

##### Configure a Pod to Use a ConfigMap - Kubernetes
참고 : https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/

Ex) 리소스 모두 삭제  
```zsh
 chap06 (master) ✗ kubectl delete -f ConfigMap
configmap "project-config" deleted
deployment.apps "configmap-deployment" deleted
service "webserver" deleted
```

---
#### 3. 비밀번호와 키 관리
* 쿠버네티스는 시크릿(Secrets) 리소스를 사용해 기밀 정보를 관리함
	- API키, DB 연결용 ID/비밀번호, TLS에 필요한 키와 인증서 등
* 시크릿의 구조는 컨피그맵과 비슷함
	- 컨피그맵 : 프레인 텍스트로 etcd 안에 저장됨
	- 시크릿 : etcd 안에 __암호화된 상태로 관리__됨
	
##### 쿠버네티스의 매니페스트 파일을 작성

Ex) chap06/Secrets/secrets.yaml  
```yaml
# (1) 基本項目
apiVersion: v1
kind: Secret
metadata:
  name: api-key
type: Opaque

# (2) Secretで設定するDATA
data:
  id: ZGJ1c2Vy
  key: YUJjRDEyMw==
```
* [kind]필드는 'Secret', 'api-key'라는 이름의 시크릿 정의

* [type]필드에 설정할 수 있는 값
설정 값 | 설명
---|---
type: Opaque	| 일반적인 기밀 정보
type: kubernetes.io/tls	| TLS 정보
type: kubernetes.io/dockerconfigjson	| Docker Registry 정보
type: kubernetes.io/service-account-token	| Service Account 정보

* secrets.yaml의 [data]필드
설정 값 | 값 | base64 인코딩
:-:|:-:|:-:
id	| dbuer	| ZGJ1c2Vy
key	| aBcD123	| YUJjRDEyMw==

Ex) 시크릿 작성 및 확인 
```zsh
 chap06 (master) ✗ kubectl apply -f Secrets/secrets.yaml
secret/api-key created
 chap06 (master) ✗ kubectl describe secrets api-key
Name:         api-key
Namespace:    default
Labels:       <none>
Annotations:
Type:         Opaque

Data
====
id:   6 bytes
key:  7 bytes
```

##### 기밀 정보 파일을 마운트


Ex) 시크릿 등록(설정, 마운트)  
```zsh
 chap06 (master) ✗ kubectl create secret generic apl-auth --from-file=Secrets/key/
secret/apl-auth created
```
* `--from-file`을 사용해 파일 경로 및 파일명(디렉터리명) 지정
* 'key' 디렉터리에 있는 설정 파일을 모아서 'apl-auth'라는 이름의 시크릿으로 등록
	- 'key' 디텍터리 안에는 'apl.crt' 파일 존재, 내용은 별거 없음
	

Ex) 시크릿 목록 확인  
```zsh
 chap06 (master) ✗ kubectl get secrets
NAME                  TYPE                                  DATA   AGE
api-key               Opaque                                2      42m
apl-auth              Opaque                                1      2m56s
default-token-qdcvt   kubernetes.io/service-account-token   3      7d1h
```
* Git과 같은 버전 관리 시스템에 저장은 피함
	- 퍼브릭 리포지토리에 푸시하면 정보 유출 가능성 있음

---
#### 4. Secrets 값 참조

##### 환경변수로써 전달하기
* 컨피그맵을 환경변수로 전달할 때는 [containers]-[env]필드를 사용

Ex) chap06/Secrets/deployment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
~생략~
        env:
        # Secrets를 환경변수에 설정
        - name: SECRET_ID
          valueFrom:
            secretKeyRef:
              name: api-key
              key: id
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: api-key
              key: key
~생략~
```
* [valueFrom]을 'secretKeyRef' 하고, 참조하고 싶은 이름을 [name], 키는 [key] 필드에 설정
* 위쪽에서 정의한 'api-key'라는 이름의 시크릿으로부터 'id'와 'key'를 각각 환경변수 SECRET_ID와 SECRET_KEY로 설정

##### Volume으로써 마운트하기
* 등록한 시크릿을 파일로써 마운트할려면 [containers]-[voulumeMounts]필드에 설정
  

Ex) chap06/Secrets/deployment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
~생략~
    spec:
      containers:
~생략~
        env:
        # Secretsのマウント設定
        volumeMounts:
          - name: secrets-volume
            mountPath: /etc/secrets
            readOnly: true

      # Secrets의 볼륨 마운트
      volumes:
        - name: secrets-volume
          secret:
            secretName: apl-auth
```
* 위에서 설정한 'app-auth'라는 이름의 시크릿을 컨테이너 '/etc/secrets/'에 마운트

Ex) 디플로이먼트 리소스 작성 및 포드 목록 확인  
```zsh
 chap06 (master) ✗ kubectl apply -f Secrets/deployment.yaml
deployment.apps/secret-deployment created
 chap06 (master) ✗ kubectl get pod
NAME                                 READY   STATUS    RESTARTS   AGE
secret-deployment-78db8f5f9b-jbnpn   1/1     Running   0          4s
secret-deployment-78db8f5f9b-msg9n   1/1     Running   0          4s
secret-deployment-78db8f5f9b-xnlmd   1/1     Running   0          4s
```
* 디플로이 전 리포지토리 위치 변경

Ex) 포드 하나에 접속 및 환경 변수 확인  
```zsh
 chap06 (master) ✗ kubectl exec -it secret-deployment-78db8f5f9b-jbnpn  /bin/bash
root@secret-deployment-78db8f5f9b-jbnpn:/# env | grep SECRET*
SECRET_KEY=aBcD123
SECRET_ID=dbuser
```

Ex) 마운트한 파일 확인  
```zsh
root@secret-deployment-78db8f5f9b-jbnpn:/# ls /etc/secrets
apl.crt
root@secret-deployment-78db8f5f9b-jbnpn:/# cat /etc/mtab | grep /etc/secrets
tmpfs /etc/secrets tmpfs ro,relatime 0 0
```
* '/etc/scrects'는 'tmpfs'로 마운트 된 것을 확인
	- '/etc/scrects' 디렉터리는 디스크가 아니라 메모리상에 전개됨
	- mtab: 현재 마운트 되어 있는 파일 시스템의 일람이 기록
* 남은 두 대의 포드도 확인하면 똑같은 환경변수와 파일이 마운트되어 있을 것임


Ex) 리소스 모두 삭제  
```zsh
 chap06 (master) ✗ kubectl delete -f Secrets/
deployment.apps "secret-deployment" deleted
secret "api-key" deleted
```

### 환경 삭제
Ex) ACR과 AKS 리소스 그룹 삭제  
```zsh
 chap06 (master) ✗ ACR_RES_GROUP=sampleACR9988
 chap06 (master) ✗ AKS_RES_GROUP=AKSCluster
 chap06 (master) ✗ az group delete --resource-group $ACR_RES_GROUP
Are you sure you want to perform this operation? (y/n): y
 chap06 (master) ✗ az group delete --resource-group $AKS_RES_GROUP
Are you sure you want to perform this operation? (y/n): y
```

Ex) 서비스 프린서플 삭제  
```zsh
 chap06 (master) ✗ SP_NAME=sample-acr-service-principal
 chap06 (master) ✗ az ad sp delete --id=$(az ad sp show --id http://$SP_NAME --query appId --output tsv)
```

---
## 6.4 정리
* 버전업의 개념
* 매니페스트 파일의 작성 방법
* 롤링 업데이트의 구조
* 블루/그린 디플로이먼트
* 컨피그맵 및 시크릿의 개념 및 실습

---
[^출처]: 완벽한 IT 인프라 구축의 자동화를 위한 Kubernetes-정보문화사
