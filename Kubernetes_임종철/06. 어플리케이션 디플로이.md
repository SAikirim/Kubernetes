# 06. 어플리케이션 디플로이

### 샘플 어플리케이션 다운로드
```zsh
$ git clone https://github.com/ToruMakabe/Understanding-K8s
$ cd Understanding-K8s/chap06
```

---
## 6.1 디플로이먼트를 사용한 어플리케이션 디플로이


---
#### 1. 어플리케이션의 버전업 개념
* 작은 단위로 어플리케이셩 추가 기능을 넣거나 수정하여 짧은 기간에 릴리스하는 방법을 사용
	- 버전업에는 위험이 따름(오류 및 서비스 장애)
	- 안전한 어플리케이션을 가능한 신속하게 디플로이할 수 잇는 구조가 중요

* 디플로이하는 방법

##### 롤링 업데이트
* 한꺼번에 변경하는 것이 아닌, 조금씩 순서대로 갱신하는 방법(어플리케이션 버전을 조금씩 교체)
	- 신구 어플리케이션이 동시에 혼재하게 됨
	- 어플리케이션이 롤링 업데이트를 지원해야함

##### 불루/그린 업데이트
* 버전이 다른 두 어플리케이션을 동시에 가동시켜 두고 네트워크 설정을 이용하여 변경
	- 블루(구)와 그린(신)을 전환
	- 대기 머신인 그린 쪽에서 사전 테스트, 테스트 통과 후 서비스 전환
	- 장애 발생신 블루(구)로 바로 되돌릴 수 있음

##### 카나리아 릴리스(Canary Release)
* 일부 이용자에게만 새 기능을 제공하여 문제 확인 후, 모든 사용자에게 대규모 전개

---
#### 2. 디플로이먼트
* '컨테이너 어플리케이셩의 버전업' -> 액세스할 포드를 바꾼다'른 것과 똑같음
* 이것을 모아서 관리하는 기능이 디플로이먼트(Deployment)
* 포드 및 레플리카셋은 이력관리 없음, 디플로이먼트 이력 관리 가능(배부에서 레플리카셋의 이력을 관리)
* 디플로이먼트가 가능한 일
	- 포드의 롤아웃/롤백
	- 롤아웃 방식의 지정
	- 롤아웃 조건이나 속도 제어

---
#### 3. 매니페스트 파일

Ex) chap06/Deployment/nginx-deployment.yaml  
```yaml
# （1） 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # 레플리카 수
  selector:
    matchLabels:
      app: nginx-pod   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.14   # 컨테이너 이미지의 위치
        ports:
        - containerPort: 80   # 포드 번호
```
##### (1) 매니페스트 기본 항목
* API의 버전이나 포드명 같은 기본 항목 설정

필드| 데이터형 | 설명
---|---|---
apiVersion	| 문자열 | API의 버전(app/v1), 존재하니 않은 값을 설정하면 오류
kind 	| 문자열| 쿠버네티스 리소스 종류(Deployment)
metadata	| Object | Deployment의 이름이나 Label과 같은 메타데이터
spec	| PodSpec | Deployment의 상세 정보 설정


##### (2) 디플로이먼트 스펙
* [spec] 필드에는 디플로이먼트의 내용을 설정
	- 포드 안에서 실행시키소 싶은 포드 수를 replicas로 설정, 어떤 포드를 새로 가동시킬지 템플릿 설정

필드| 데이터형 | 설명
---|---|---
replicas	| 정수 | 클러스터 안에서 가동시킬 포드 수, 기본값 1
selector	| LabelSelector| 어떤 포드를 가동시킬지에 대한 셀렉터. 포드의 에 설정된 Template 라벨과 일치해햐 함
template	| PodTemplateSpec | 실제로 클러스터 안에서 움직이는 포드의 수가 replicas에 설정된 포드의 수를 만족시키지 않을 때 새로 작성되는 포드의 템플릿

	
##### (3) 포드 템플릿
* [template]필드에는 가동시키고 싶은 포드의 템플릿을 지정
* selector에서 지정한 조건과 맞는 것을 만들 필요가 있음

필드| 데이터형 | 설명
---|---|---
metadata	| Object | 템플릿의 이름이나 Label과 같은 메타테이터
spec	| PodSpec | pod의 상세 정보 설정

##### Deployment v1 apps - Kubernetes API Reference Docs
참고 : https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#deployment-v1-apps

---
#### 디플로이먼트 작성, 변경, 삭제

##### 디플로이먼트 작성
Ex) 디플로이먼트 작성 및 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl apply -f Deployment/nginx-deployment.yaml                         [git:master] ✖
deployment.apps/nginx-deployment created

~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           20s
```
* 자동으로 레플리카셋과 포드가 만들어짐
* 디플로이먼트 명령 결과
항목 | 설명
NAME | 디플로이먼트명
READY | 가동 가능한 레플리카 수/총 설정된 레플리카 수
UP-TO-DATE | 갱신된 레플리카 수
AVAILABLE | 사용 가능한 레플리카 수
AGE	| 어플리케이션 실행 시간

Ex) 포드 및 레플리카셋 확인  
```zsh
➞  kubectl get replicaset,pod                                                [git:master] ✖
NAME                                                DESIRED   CURRENT   READY   AGE
replicaset.extensions/nginx-deployment-789d949f8b   3         3         3       59s

NAME                                    READY   STATUS    RESTARTS   AGE
pod/nginx-deployment-789d949f8b-75xr4   1/1     Running   0          59s
pod/nginx-deployment-789d949f8b-8sbx9   1/1     Running   0          59s
pod/nginx-deployment-789d949f8b-ml9m2   1/1     Running   0          59s
```
* [NAME] : 디플로이먼트명-레플리카셋_내부_ID-포드_내부_ID
![포드, 레플리카, 디플로이먼트의 이름](.\06. 어플리케이션 디플로이\kubernetes_00_포드레플리카디플로이먼트이름.jpg)[^출처]

Ex) 디플로이먼트 상세정보  
```zsh
➞  kubectl describe deploy nginx-deployment                                  [git:master] ✖
Name:                   nginx-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 10:40:29 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 1
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"nginx-deployment","namespace":"default"},"spec":{"replica...
Selector:               app=nginx-pod
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx-pod
  Containers:
   nginx:
    Image:        nginx:1.14
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   nginx-deployment-789d949f8b (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deployment-789d949f8b to 3
```
* [OldReplicaSets:]와 [NewReplicaSet:] : 레플리카셋의 이력을 유지

##### 디플로이먼트 변경

Ex) chap06/Deployment/nginx-deployment.yaml  
```yaml
# （1） 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment

# (2) Deploymentのスペック
spec:
  replicas: 3   # 레플리카 수
  selector:
    matchLabels:
      app: nginx-pod   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
      - name: nginx
        image: nginx:1.14   # 컨테이너 이미지의 위치
        ports:
        - containerPort: 80   # 포드 번호
```
* 'image: nginx:1.14' -> 'image: nginx:1.15'로 변경

Ex) 디플로이먼트 갱신 및 확인  
```zsh
➞  kubectl apply -f Deployment/nginx-deployment.yaml                         [git:master] ✖
deployment.apps/nginx-deployment configured

~/Understanding-K8s/chap06
➞  kubectl describe deploy nginx-deployment                                  [git:master] ✖
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    ReplicaSetUpdated
OldReplicaSets:  nginx-deployment-789d949f8b (3/3 replicas created)
NewReplicaSet:   nginx-deployment-69fdb6677 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  16m   deployment-controller  Scaled up replica set nginx-deployment-789d949f8b to 3
  Normal  ScalingReplicaSet  7s    deployment-controller  Scaled up replica set nginx-deployment-69fdb6677 to 1
```
* 'nginx-deployment-789d949f8b' -> 'nginx-deployment-69fdb6677' 대체 확인

Ex) 디플로이먼트 내부 레플리카셋 이력 확인  
```zsh
➞  kubectl get replicaset --output=wide                                      [git:master] ✖
NAME                          DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES       SELECTOR
nginx-deployment-69fdb6677    3         3         3       2m51s   nginx        nginx:1.15   app=nginx-pod,pod-template-hash=69fdb6677
nginx-deployment-789d949f8b   0         0         0       18m     nginx        nginx:1.14   app=nginx-pod,pod-template-hash=789d949f8b
```
* 'pod-template-hash='에는 해시 값이 자동으로 븥음
	- 이 값을 사용해 내부에서 포드를 식벽, 값 변경 금지

##### 디플로이먼트 삭제

Ex) 디플로이먼트 삭제 및 확인 
```zsh
~/Understanding-K8s/chap06
➞  kubectl delete -f Deployment/nginx-deployment.yaml                        [git:master] ✖
deployment.apps "nginx-deployment" deleted
~/Understanding-K8s/chap06
➞  kubectl get replicaset,pod,deploy                                         [git:master] ✖
No resources found in default namespace.
```
* 디플로이먼트를 삭제하면 연결되어 있던 리플리카셋 및 포드 모두 삭제됨

---
## 6.2 디플로이먼트의 구조
![샘플 어플리케이션 개요](.\06. 어플리케이션 디플로이\kubernetes_01_샘플어플리케이션개요.jpg)[^출처]

---
#### 1. 업데이트 처리 방식
* 리크리에이트(Recreate)
	- 오래된 포드를 일단 정지시키고 새로운 포드를 다시 작성하는 방법
	- 심플하며 속도가 빠름, 다운타임이 발생
	
* 롤링 업데이트(RollongUpdate)
	- 클러스터에서 움직이는 포드를 조금씩 업데이트해 가는 방식
	- 새로운 포드의 실행이 확인되면 오래된 포드를 정지
	- 신구 버전이 동시에 존재(처리 방법은 복잡), 다운타임이 없음
	
![업데이트 방식](.\06. 어플리케이션 디플로이\kubernetes_02_업데이트방식.jpg)[^출처]

Ex) 업데이트 처리 방식의 설정  
```zsh
# B. Deploymentのスペック
spec:
  replicas: 10   # 레플리카 수

  # 업데이트 방식
  strategy:
    type: Recreate
```
* 디플로이먼트의 [spec:]-[strategy:]-[type:]에서 설정
	- 설정 가능 값  'Recreate' 및 'RollingUpdate'
	- 명시적 지정이 없으면 기본값 : 'RollingUpdate'

---
#### 2. 롤아웃
* 어플리케이션을 클러스터 안에 디플로이하여 서비스를 가동시키는 것

Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
# (1) 基本項目
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollout-deployment

# (2) Deploymentのスペック
spec:
  replicas: 5   # 레플리카 수
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건

  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v1.0   # 여기를 변경한다
        name: photoview-container   # コンテナ名
        ports:
        - containerPort: 80   # 포드 번호
---
# A. 基本項目
apiVersion: v1
kind: Service
metadata:
  name: rollout

# B. Serviceのスペック
spec:
  type: LoadBalancer
  ports:   # 포트번호
    - port: 80
      targetPort: 80
      protocol: TCP

  # C. Pod 조건(ラベル)
  selector:
    app: photo-view
```
* 'rollout-deployment'라는 이름의 디플로이먼트를 만듦
* 5개의 포드 실행
* [image] 필드는 자신의 레지스트리 주소로 변경
* 서비스 리소스도 작성

Ex) 디플로이먼트 및 서비스 작성과 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment created
service/rollout created

~/Understanding-K8s/chap06
➞  kubectl rollout status deploy rollout-deployment                          [git:master] ✖
deployment "rollout-deployment" successfully rolled out

~/Understanding-K8s/chap06
➞  kubectl get pod                                                           [git:master] ✖

NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-fd94bf9b7-2xlhh   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-kgdp7   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-vz2pm   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-wmwvj   1/1     Running   0          20s
rollout-deployment-fd94bf9b7-xfrrs   1/1     Running   0          20s
```

Ex) 외부에서 액세스 할 수 있는 글로벌IP 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl get service                                                       [git:master] ✖
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE
kubernetes   ClusterIP      10.0.0.1       <none>           443/TCP        6d
rollout      LoadBalancer   10.0.162.173   52.231.112.242   80:30325/TCP   2m41s
```

![동작 확인](.\06. 어플리케이션 디플로이\kubernetes_03_동작확인.png)
* '52.231.112.242'에 접속 동작 확인


Ex) 디플로이먼트 상세 정보 확인1  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 1
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"rollout-deployment","namespace":"default"},"spec":{"repli...
~생략~
```
* [Annotations:]필드에 'revision: 1'이 자동 추가됨
	- 이 값은 디플로이먼트의 리버전을 뜻하며, 롤링 업데니트를 할 때 마다 증가

Ex) 디플로이먼트 상세 정보 확인2  
```zsh
~생략~
Selector:               app=photo-view
Replicas:               5 desired | 5 updated | 5 total | 5 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
~생략~
```
* 롤링 업데이트의 상황 확인 가능

Ex) 디플로이먼트 상세 정보 확인3  
```zsh
~생략~
Pod Template:
  Labels:  app=photo-view
  Containers:
   photoview-container:
    Image:        sampleacr9988.azurecr.io/photo-view:v1.0
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
~생략~
```
* 포드의 상세 정보는 레플리카셋이나 포드의 경우와 똑같음
* 포드 상양 확인 가능

Ex) 디플로이먼트 상세 정보 확인4  
```
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   rollout-deployment-fd94bf9b7 (5/5 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  6m47s  deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
```
* [Conditions:] : 디플로이먼트 상태 확인
* [Events:] : 로그 상태 확인
* [OldReplicaSets:] : 구버전 레플리카셋
* [NewReplicaSet:] : 신버전 레플리카셋

##### 어플리케이션 버전업
Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v2.0   # 여기를 변경한다(v1.0 => v2.0)
        name: photoview-container   # コンテナ名
~생략~
```

Ex) 디플로이먼트 갱신 및 확인  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged

~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
rollout-deployment   5/5     5            5           17m

~/Understanding-K8s/chap06
➞  kubectl get rs                                                            [git:master] ✖
NAME                            DESIRED   CURRENT   READY   AGE
rollout-deployment-57df5b5978   5         5         5       33s
rollout-deployment-fd94bf9b7    0         0         0       17m
```

Ex) [Events]의 로그를 확인  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
~생략~
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  18m   deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 2
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 4
  Normal  ScalingReplicaSet  92s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 3
  Normal  ScalingReplicaSet  90s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 3
  Normal  ScalingReplicaSet  90s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 4
  Normal  ScalingReplicaSet  88s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 2
  Normal  ScalingReplicaSet  88s   deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 5
  Normal  ScalingReplicaSet  86s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 1
  Normal  ScalingReplicaSet  85s   deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 0
```
* 'rollout-deployment-fd94bf9b7'에서 'rollout-deployment-57df5b5978'로 교체
	1. 새로운 레플리카셋을 작성
	2. 새로운 레플리카셋의 포드를 늘림
	3. 오래된 레플리카셋의 포드를 줄임
	4. 오래된 레플리카셍의 포드라 0이 될 때까지 2.와 3.을 반복
* 서비스가 정지되지 않도록 내부에서 무결성을 취하면서 서서히 롤아웃함

---
#### 3. 롤백
Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
  # (3) Pod 템플릿
  template:
    metadata:
      labels:
        app: photo-view

    spec:
      containers:
      - image: sampleacr9988.azurecr.io/photo-view:v1.0   # 여기를 변경한다(v2.0 => v1.0)
        name: photoview-container   # コンテナ名
~생략~
```

Ex) 디플로이먼트 갱신  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged
```

Ex) 디플로이먼트 상세 정보 확인1  
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 3
                        kubectl.kubernetes.io/last-applied-configuration:
                          {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"rollout-deployment","namespace":"default"},"spec":{"repli...
~생략~
```
* [Annotations:]필드가 'revision: 3'으로 올라간 것을 확인

Ex) 디플로이먼트 상세 정보 확인2  
```zsh
~생략~
Pod Template:
  Labels:  app=photo-view
  Containers:
   photoview-container:
    Image:        sampleacr9988.azurecr.io/photo-view:v1.0
~생략~
```
* 포드 템플릿 이미지가 'v2.0'에서 'v1.0'로 변경 확인

Ex)   
```zsh
~생략~
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   rollout-deployment-fd94bf9b7 (5/5 replicas created)
Events:
  Type    Reason             Age                  From                   Message
  ----    ------             ----                 ----                   -------
  Normal  ScalingReplicaSet  27m                  deployment-controller  Scaled up replica set rollout-deployment-fd94bf9b7 to 5
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 2
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 4
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 3
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 3
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 4
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 2
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled up replica set rollout-deployment-57df5b5978 to 5
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 1
  Normal  ScalingReplicaSet  10m                  deployment-controller  Scaled down replica set rollout-deployment-fd94bf9b7 to 0
  Normal  ScalingReplicaSet  110s (x9 over 114s)  deployment-controller  (combined from similar events): Scaled down replica set rollout-deployment-57df5b5978 to 0
```
* 'rollout-deployment-fd94bf9b7'로 되돌아 온 것을 확인


Ex) 디플로이먼트 및 레플리카셋 확인  
```zsh
~/Understanding-K8s/chap06
➞  kubectl get deploy                                                        [git:master] ✖
NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
rollout-deployment   5/5     5            5           35m

~/Understanding-K8s/chap06
➞  kubectl get rs                                                            [git:master] ✖
NAME                            DESIRED   CURRENT   READY   AGE
rollout-deployment-57df5b5978   0         0         0       17m
rollout-deployment-fd94bf9b7    5         5         5       35m
```
* 디플로이먼트의 리버전은 'revision:2.0'에서 'revision:3.0'으로 올라갔지만
* 참조한 레플리카셋은 'revision:3.0'과  'revision:1.0'이 똑같은 것을 사용하여 포드를 기동시키고 있음
* __갖고 있는 이력을 바탕으로 롤백하고 있음__

---
#### 4. 롤아웃 조건
* 롤아웃은 극단적으로 말하면 '포드를 변경하기' 위한 장치
	- 포드 템플릿 이외의 변경에는 리비전이 올라가지 않음
	
Ex) chap06/Deployment/rollout-depoyment.yaml   
```yaml
~생략~
# (2) Deploymentのスペック
spec:
  replicas: 10   # 레플리카 수(5 => 10 변경)
  selector:
    matchLabels:
      app: photo-view   # 템플릿 검색 조건
~생략~
```

Ex) 디플로이먼트 갱신 및 포드 개수 확인  
```zsh
➞  kubectl apply -f Deployment/rollout-depoyment.yaml                        [git:master] ✖
deployment.apps/rollout-deployment configured
service/rollout unchanged

~/Understanding-K8s/chap06
➞  kubectl get pod                                                           [git:master] ✖
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-fd94bf9b7-4btm2   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-4xzss   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-8hhtc   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-brzn5   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-cwzbm   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-f4wc7   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-nzcmm   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-q7mbn   1/1     Running   0          9s
rollout-deployment-fd94bf9b7-tms99   1/1     Running   0          52m
rollout-deployment-fd94bf9b7-vlgb7   1/1     Running   0          9s
```

Ex) 디플로이먼트 상세 확인   
```zsh
➞  kubectl describe deploy rollout-deployment                                [git:master] ✖
Name:                   rollout-deployment
Namespace:              default
CreationTimestamp:      Mon, 23 Mar 2020 11:49:05 +0900
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 3
~생략~
```	
* [Annotations:]필드의 'revision: 3'상태 그대로인 것을 확인
	- 디플로이먼트 매니페스트의 [template] 필드의 생신 외에는 업데이트되지 않음(주의 필요)
	- 포드 템플릿을 변경했을 때만 롤아웃 됨

Ex) 디플로이먼트 이력 확인  
```zsh
~ kubectl rollout history deployment rollout-deployment
deployment.extensions/rollout-deployment
REVISION  CHANGE-CAUSE
2         <none>
3         <none>
```
* 'kubectl rollout history' 명령을 사용하여 롤아웃에서 어떤 변경이 일어났는지 확인

Ex) 리비전별 상세 내용 확인  
```zsh
chap06 [master●] kubectl rollout history deployment rollout-deployment --revision=3
deployment.extensions/rollout-deployment with revision #3
Pod Template:
  Labels:       app=photo-view
        pod-template-hash=fd94bf9b7
  Containers:
   photoview-container:
    Image:      sampleacr9988.azurecr.io/photo-view:v1.0
    Port:       80/TCP
    Host Port:  0/TCP
    Environment:        <none>
    Mounts:     <none>
  Volumes:      <none>
```
* 'revision=3'의 내용 확인
* 장기간 운용시 '이력 정보'가 커짐, 롤백 세대를 지정을 권잔(기본값: 10)
	- 변경시 디플로이먼트 스펙에서 [revisionHistroryLimit]를 설정

##### Deployments - Kuberntes
참고 : https://kubernetes.io/docs/concepts/workloads/controllers/deployment

Ex) 리소스 삭제  
```zsh
chap06 [master●] kubectl delete -f Deployment/rollout-depoyment.yaml
deployment.apps "rollout-deployment" deleted
service "rollout" deleted
```

---
#### 5. 롤링 업데이트 제어
* 디플로이먼트는 롤링 처리를 세세하게 제어 가능
	- Ex) 업데이트 중에 서능을 최소한으로 줄이기

###### 사용할 수 없는 포드 제어(maxUnavilable)
* 업데이트 중, 사용 못 해도 괜찮은 포드의 최대 개수를 지정
* 디플로이먼트의 [spec:]-[rollongUpdate]-[maxUnavailable]에서 설정
Ex) [maxUnavailable]를 30%로 설정(10개의 포드를 가동중이라면)
	- 70%이상, 7개 이상의 포드가 클러스터 안에서 항상 이용할 수 있는 상태를 유지
	- [maxUnavailable]를 명시적으로 지정하지 않았을 땐(기본값: 25%)

###### 클러스터에서 포드를 작성할 수 있는 최대 개수(maxSurge)


---
#### 6. 블루/그린 디플로이먼트

Ex)   
```zsh

```

Ex)   
```zsh

```

---
## 6.3 어플리케이션의 설정 정보를 관리하자

---
#### 1. 어플리케이셔의 설정 정보 관리

---
#### 2. ConfigMap 값 참조

---
#### 3. 비밀번호와 키 관리

---
#### 4. Secrets 값 참조

Ex)   
```zsh

```

Ex)   
```zsh

```

---
## 6.4 정리


---
[^출처]: 완벽한 IT 인프라 구축의 자동화를 위한 Kubernetes-정보문화사